#!/usr/bin/env node
/**
 * Complete System Test - Quote Builder Phase 1 + Phase 2
 * Tests entire flow from lead creation to PDF/Email delivery
 */

import { createClient } from '@supabase/supabase-js';

const SUPABASE_URL = process.env.NEXT_PUBLIC_SUPABASE_URL;
const SUPABASE_KEY = process.env.SUPABASE_SERVICE_ROLE_KEY;
const BASE_URL = 'http://localhost:3000';

if (!SUPABASE_URL || !SUPABASE_KEY) {
  console.error('âŒ Missing environment variables');
  process.exit(1);
}

const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

// Test data
const testLeadId = '9cd14112-86a1-4803-9c15-13e833483d89';

console.log('ğŸ§ª Complete System Test - Quote Builder\n');
console.log('Testing Phase 1 + Phase 2 features...\n');

// ============================================================================
// Test 1: Database Schema
// ============================================================================

async function testDatabaseSchema() {
  console.log('ğŸ“Š Test 1: Database Schema Verification');

  const tables = [
    'quote_regions',
    'quote_customer_tiers',
    'quote_leads',
    'suppliers',
    'products',
    'quotations',
    'quotation_lines',
    'quotation_versions',
    'quotation_audit_log'
  ];

  for (const table of tables) {
    const { data, error } = await supabase.from(table).select('*').limit(1);

    if (error) {
      console.log(`   âŒ Table '${table}' - ${error.message}`);
      return false;
    }
    console.log(`   âœ… Table '${table}' exists`);
  }

  console.log('');
  return true;
}

// ============================================================================
// Test 2: Test Lead Exists
// ============================================================================

async function testLeadExists() {
  console.log('ğŸ‘¤ Test 2: Test Lead Verification');

  const { data: lead, error } = await supabase
    .from('quote_leads')
    .select('*')
    .eq('id', testLeadId)
    .single();

  if (error || !lead) {
    console.log('   âŒ Test lead not found');
    return false;
  }

  console.log(`   âœ… Lead found: ${lead.name} (${lead.email})`);
  console.log(`   âœ… Region: ${lead.region_id}`);
  console.log(`   âœ… Tier: ${lead.tier_id}\n`);
  return true;
}

// ============================================================================
// Test 3: Products Available
// ============================================================================

async function testProductsAvailable() {
  console.log('ğŸ“¦ Test 3: Product Catalog');

  const { data: products, error } = await supabase
    .from('products')
    .select('*')
    .limit(5);

  if (error || !products || products.length === 0) {
    console.log('   âŒ No products found');
    return false;
  }

  console.log(`   âœ… ${products.length} products available`);
  products.forEach(p => {
    console.log(`      - ${p.name} ($${p.base_price})`);
  });
  console.log('');
  return products;
}

// ============================================================================
// Test 4: Pricing API
// ============================================================================

async function testPricingAPI(products) {
  console.log('ğŸ’° Test 4: Pricing Calculation API');

  const testItems = [
    {
      productId: products[0].id,
      category: products[0].category,
      quantity: 5
    }
  ];

  const response = await fetch(`${BASE_URL}/api/quote/pricing/calculate`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      leadId: testLeadId,
      items: testItems
    })
  });

  const data = await response.json();

  if (!response.ok) {
    console.log(`   âŒ Pricing API failed: ${data.error}`);
    console.log(`      Details: ${JSON.stringify(data.details)}`);
    return false;
  }

  console.log(`   âœ… Pricing calculated successfully`);
  console.log(`      Subtotal: $${data.summary.subtotal.toFixed(2)}`);
  console.log(`      Tax: $${data.summary.tax.amount.toFixed(2)}`);
  console.log(`      Total: $${data.summary.total.toFixed(2)}\n`);

  return data;
}

// ============================================================================
// Test 5: Quote Generation API
// ============================================================================

async function testQuoteGenerationAPI(pricingData) {
  console.log('ğŸ“ Test 5: Quote Generation API');

  const response = await fetch(`${BASE_URL}/api/quote/generate`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      leadId: testLeadId,
      lineItems: pricingData.lineItems,
      subtotal: pricingData.summary.subtotal,
      taxPlaceholder: pricingData.summary.tax.amount,
      total: pricingData.summary.total,
      customerNotes: 'Test quote generated by automated test'
    })
  });

  const data = await response.json();

  if (!response.ok) {
    console.log(`   âŒ Quote generation failed: ${data.error}`);
    console.log(`      Details: ${JSON.stringify(data.details)}`);
    return false;
  }

  console.log(`   âœ… Quote generated successfully`);
  console.log(`      Quote Number: ${data.quotation.quoteNumber}`);
  console.log(`      Quote ID: ${data.quotation.id}`);
  console.log(`      Total: $${data.quotation.total.toFixed(2)}`);
  console.log(`      Line Items: ${data.quotation.lineItemCount}\n`);

  return data.quotation;
}

// ============================================================================
// Test 6: Quote Retrieval API
// ============================================================================

async function testQuoteRetrievalAPI(quoteId) {
  console.log('ğŸ” Test 6: Quote Retrieval API');

  const response = await fetch(`${BASE_URL}/api/quote/generate?id=${quoteId}`);
  const data = await response.json();

  if (!response.ok) {
    console.log(`   âŒ Quote retrieval failed: ${data.error}`);
    return false;
  }

  console.log(`   âœ… Quote retrieved successfully`);
  console.log(`      Quote Number: ${data.quotation.quoteNumber}`);
  console.log(`      Status: ${data.quotation.status}`);
  console.log(`      Total: $${data.quotation.total}`);
  console.log(`      Line Items: ${data.quotation.line_items.length}\n`);

  return data.quotation;
}

// ============================================================================
// Test 7: PDF Generation API (Phase 2)
// ============================================================================

async function testPDFGenerationAPI(quoteId) {
  console.log('ğŸ“„ Test 7: PDF Generation API (Phase 2)');

  const response = await fetch(`${BASE_URL}/api/quote/pdf/${quoteId}`);

  if (!response.ok) {
    const data = await response.json();
    console.log(`   âŒ PDF generation failed: ${data.error}`);
    return false;
  }

  const contentType = response.headers.get('content-type');
  const contentLength = response.headers.get('content-length');

  if (contentType !== 'application/pdf') {
    console.log(`   âŒ Wrong content type: ${contentType}`);
    return false;
  }

  console.log(`   âœ… PDF generated successfully`);
  console.log(`      Content Type: ${contentType}`);
  console.log(`      Size: ${(contentLength / 1024).toFixed(2)} KB\n`);

  return true;
}

// ============================================================================
// Test 8: Email Delivery API (Phase 2)
// ============================================================================

async function testEmailDeliveryAPI(quoteId) {
  console.log('ğŸ“§ Test 8: Email Delivery API (Phase 2)');

  const response = await fetch(`${BASE_URL}/api/quote/email/${quoteId}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      email: 'test@example.com'
    })
  });

  // If response is HTML, it's an error page
  const contentType = response.headers.get('content-type');
  if (contentType && contentType.includes('text/html')) {
    const htmlText = await response.text();
    if (htmlText.includes('Missing API key') || htmlText.includes('RESEND_API_KEY')) {
      console.log(`   âš ï¸  Email API not configured (expected)`);
      console.log(`      Add RESEND_API_KEY to .env to enable email\n`);
      return 'skipped';
    }
    console.log(`   âŒ Email delivery failed: Server returned HTML error page`);
    return false;
  }

  const data = await response.json();

  if (!response.ok) {
    // Check if it's just missing API key (expected in test)
    if (data.error && (data.error.includes('RESEND_API_KEY') || data.error.includes('Missing API key'))) {
      console.log(`   âš ï¸  Email API not configured (expected)`);
      console.log(`      Add RESEND_API_KEY to .env to enable email\n`);
      return 'skipped';
    }
    console.log(`   âŒ Email delivery failed: ${data.error}`);
    return false;
  }

  console.log(`   âœ… Email sent successfully`);
  console.log(`      To: ${data.sentTo}`);
  console.log(`      Email ID: ${data.emailId}\n`);

  return true;
}

// ============================================================================
// Test 9: Audit Log Verification
// ============================================================================

async function testAuditLog(quoteId) {
  console.log('ğŸ“‹ Test 9: Audit Log Verification');

  const { data: logs, error } = await supabase
    .from('quotation_audit_log')
    .select('*')
    .eq('entity_id', quoteId)
    .order('created_at', { ascending: false });

  if (error) {
    console.log(`   âŒ Audit log query failed: ${error.message}`);
    return false;
  }

  if (!logs || logs.length === 0) {
    console.log(`   âŒ No audit logs found for quote`);
    return false;
  }

  console.log(`   âœ… Audit log verified`);
  console.log(`      Total entries: ${logs.length}`);
  logs.forEach(log => {
    console.log(`      - ${log.action} at ${new Date(log.created_at).toLocaleString()}`);
  });
  console.log('');

  return true;
}

// ============================================================================
// Test 10: Database Integrity
// ============================================================================

async function testDatabaseIntegrity(quoteId) {
  console.log('ğŸ” Test 10: Database Integrity Check');

  // Check quotation exists
  const { data: quotation } = await supabase
    .from('quotations')
    .select('*')
    .eq('id', quoteId)
    .single();

  if (!quotation) {
    console.log(`   âŒ Quotation not found in database`);
    return false;
  }

  // Check line items exist
  const { data: lineItems } = await supabase
    .from('quotation_lines')
    .select('*')
    .eq('quotation_id', quoteId);

  if (!lineItems || lineItems.length === 0) {
    console.log(`   âŒ No line items found`);
    return false;
  }

  // Verify totals match
  const calculatedTotal = lineItems.reduce((sum, item) => sum + parseFloat(item.line_total), 0);
  const storedSubtotal = parseFloat(quotation.subtotal);

  if (Math.abs(calculatedTotal - storedSubtotal) > 0.01) {
    console.log(`   âŒ Total mismatch: calculated $${calculatedTotal} vs stored $${storedSubtotal}`);
    return false;
  }

  console.log(`   âœ… Database integrity verified`);
  console.log(`      Quotation record: Valid`);
  console.log(`      Line items: ${lineItems.length}`);
  console.log(`      Totals match: Yes\n`);

  return true;
}

// ============================================================================
// Run All Tests
// ============================================================================

async function runAllTests() {
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');

  const results = {
    passed: 0,
    failed: 0,
    skipped: 0
  };

  try {
    // Test 1: Database Schema
    if (await testDatabaseSchema()) {
      results.passed++;
    } else {
      results.failed++;
      return results;
    }

    // Test 2: Test Lead
    if (await testLeadExists()) {
      results.passed++;
    } else {
      results.failed++;
      return results;
    }

    // Test 3: Products
    const products = await testProductsAvailable();
    if (products) {
      results.passed++;
    } else {
      results.failed++;
      return results;
    }

    // Test 4: Pricing API
    const pricingData = await testPricingAPI(products);
    if (pricingData) {
      results.passed++;
    } else {
      results.failed++;
      return results;
    }

    // Test 5: Quote Generation
    const quotation = await testQuoteGenerationAPI(pricingData);
    if (quotation) {
      results.passed++;
    } else {
      results.failed++;
      return results;
    }

    // Test 6: Quote Retrieval
    if (await testQuoteRetrievalAPI(quotation.id)) {
      results.passed++;
    } else {
      results.failed++;
      return results;
    }

    // Test 7: PDF Generation (Phase 2)
    if (await testPDFGenerationAPI(quotation.id)) {
      results.passed++;
    } else {
      results.failed++;
    }

    // Test 8: Email Delivery (Phase 2)
    const emailResult = await testEmailDeliveryAPI(quotation.id);
    if (emailResult === 'skipped') {
      results.skipped++;
    } else if (emailResult) {
      results.passed++;
    } else {
      results.failed++;
    }

    // Test 9: Audit Log
    if (await testAuditLog(quotation.id)) {
      results.passed++;
    } else {
      results.failed++;
    }

    // Test 10: Database Integrity
    if (await testDatabaseIntegrity(quotation.id)) {
      results.passed++;
    } else {
      results.failed++;
    }

  } catch (error) {
    console.error('\nâŒ Fatal error during testing:', error.message);
    results.failed++;
  }

  return results;
}

// ============================================================================
// Main
// ============================================================================

const results = await runAllTests();

console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•\n');
console.log('ğŸ“Š TEST RESULTS SUMMARY\n');
console.log(`   âœ… Passed:  ${results.passed}`);
console.log(`   âŒ Failed:  ${results.failed}`);
console.log(`   âš ï¸  Skipped: ${results.skipped}`);
console.log(`   ğŸ“ˆ Total:   ${results.passed + results.failed + results.skipped}`);
console.log('');

if (results.failed === 0) {
  console.log('ğŸ‰ All tests passed! Quote Builder is working correctly.\n');
  process.exit(0);
} else {
  console.log('âš ï¸  Some tests failed. Review errors above.\n');
  process.exit(1);
}
